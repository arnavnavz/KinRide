datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  RIDER
  DRIVER
  ADMIN
}

enum RideStatus {
  REQUESTED
  OFFERED
  ACCEPTED
  ARRIVING
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum DriverPlan {
  FREE
  KIN_PRO
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         Role     @default(RIDER)
  phone        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  driverProfile       DriverProfile?
  driverSubscription  DriverSubscription?
  riderLoyalty        RiderLoyalty?
  favorites           FavoriteDriver[]      @relation("RiderFavorites")
  favoritedBy         FavoriteDriver[]      @relation("DriverFavorited")
  rideRequests        RideRequest[]         @relation("RiderRequests")
  ridesAsDriver       RideRequest[]         @relation("DriverRides")
  rideOffers          RideOffer[]           @relation("DriverOffers")
  sentMessages        Message[]             @relation("SentMessages")
  receivedMessages    Message[]             @relation("ReceivedMessages")
  conversations1      Conversation[]        @relation("ConvUser1")
  conversations2      Conversation[]        @relation("ConvUser2")
  directMessages      DirectMessage[]       @relation("DMSender")
  ratings             Rating[]              @relation("RiderRatings")
  ratingsReceived     Rating[]              @relation("DriverRatings")
  loyaltyTransactions LoyaltyTransaction[]  @relation("LoyaltyUser")
  notifications       Notification[]        @relation("UserNotifications")
  promoRedemptions    PromoRedemption[]     @relation("UserPromos")
  referralsMade       Referral[]            @relation("ReferrerReferrals")
  referralsUsed       Referral[]            @relation("RefereeReferrals")
  tipsGiven           Tip[]                 @relation("TipGiver")
  tipsReceived        Tip[]                 @relation("TipReceiver")
  wallet              Wallet?
  supportTickets      SupportTicket[]       @relation("UserTickets")
}

model DriverProfile {
  id           String  @id @default(cuid())
  userId       String  @unique
  user         User    @relation(fields: [userId], references: [id])
  vehicleMake  String
  vehicleModel String
  vehicleYear  Int
  vehicleColor String
  licensePlate String
  isVerified   Boolean @default(false)
  isOnline     Boolean @default(false)
  kinCode      String  @unique
  lastKnownLat Float?
  lastKnownLng Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isOnline, isVerified])
}

model DriverSubscription {
  id        String     @id @default(cuid())
  driverId  String     @unique
  driver    User       @relation(fields: [driverId], references: [id])
  plan      DriverPlan @default(FREE)
  expiresAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model RiderLoyalty {
  id            String  @id @default(cuid())
  riderId       String  @unique
  rider         User    @relation(fields: [riderId], references: [id])
  credits       Int     @default(0)
  lifetimeRides Int     @default(0)
  streakWeeks   Int     @default(0)
  lastRideWeek  String?

  @@index([riderId])
}

model LoyaltyTransaction {
  id            String   @id @default(cuid())
  riderId       String
  rider         User     @relation("LoyaltyUser", fields: [riderId], references: [id])
  amount        Int
  reason        String
  rideRequestId String?
  createdAt     DateTime @default(now())

  @@index([riderId, createdAt])
}

model FavoriteDriver {
  id        String   @id @default(cuid())
  riderId   String
  driverId  String
  rider     User     @relation("RiderFavorites", fields: [riderId], references: [id])
  driver    User     @relation("DriverFavorited", fields: [driverId], references: [id])
  createdAt DateTime @default(now())

  @@unique([riderId, driverId])
}

model RideRequest {
  id               String     @id @default(cuid())
  riderId          String
  rider            User       @relation("RiderRequests", fields: [riderId], references: [id])
  driverId         String?
  driver           User?      @relation("DriverRides", fields: [driverId], references: [id])
  pickupAddress    String
  dropoffAddress   String
  status           RideStatus @default(REQUESTED)
  preferKin        Boolean    @default(false)
  specificDriverId String?
  scheduledAt      DateTime?
  estimatedFare    Float?
  platformFee      Float?
  isKinRide        Boolean    @default(false)
  riderNote        String?
  rideType         String     @default("regular")
  shareToken       String     @unique @default(cuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  offers   RideOffer[]
  messages Message[]
  ratings  Rating[]
  tips     Tip[]

  @@index([riderId, status])
  @@index([driverId, status])
}

model RideOffer {
  id            String      @id @default(cuid())
  rideRequestId String
  rideRequest   RideRequest @relation(fields: [rideRequestId], references: [id])
  driverId      String
  driver        User        @relation("DriverOffers", fields: [driverId], references: [id])
  status        OfferStatus @default(PENDING)
  offeredAt     DateTime    @default(now())
  expiresAt     DateTime
  respondedAt   DateTime?

  @@index([driverId, status, expiresAt])
  @@index([rideRequestId, status])
}

model Message {
  id            String      @id @default(cuid())
  rideRequestId String
  rideRequest   RideRequest @relation(fields: [rideRequestId], references: [id])
  senderId      String
  sender        User        @relation("SentMessages", fields: [senderId], references: [id])
  receiverId    String
  receiver      User        @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content       String
  createdAt     DateTime    @default(now())
}

model Conversation {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  user1     User     @relation("ConvUser1", fields: [user1Id], references: [id])
  user2     User     @relation("ConvUser2", fields: [user2Id], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages DirectMessage[]

  @@unique([user1Id, user2Id])
}

model DirectMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  senderId       String
  sender         User         @relation("DMSender", fields: [senderId], references: [id])
  content        String
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
}

model Rating {
  id            String      @id @default(cuid())
  rideRequestId String
  rideRequest   RideRequest @relation(fields: [rideRequestId], references: [id])
  riderId       String
  rider         User        @relation("RiderRatings", fields: [riderId], references: [id])
  driverId      String
  driver        User        @relation("DriverRatings", fields: [driverId], references: [id])
  stars         Int
  comment       String?
  createdAt     DateTime    @default(now())

  @@unique([rideRequestId, riderId])
  @@index([driverId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserNotifications", fields: [userId], references: [id])
  title     String
  body      String
  type      String   // "ride_update", "message", "loyalty", "promo", "system"
  linkUrl   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read, createdAt])
}

model PromoCode {
  id             String   @id @default(cuid())
  code           String   @unique
  description    String
  discountType   String
  discountValue  Float
  maxUses        Int?
  usesCount      Int      @default(0)
  minFare        Float?
  expiresAt      DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  redemptions PromoRedemption[]
}

model PromoRedemption {
  id            String    @id @default(cuid())
  promoCodeId   String
  promoCode     PromoCode @relation(fields: [promoCodeId], references: [id])
  userId        String
  user          User      @relation("UserPromos", fields: [userId], references: [id])
  rideRequestId String?
  discount      Float
  createdAt     DateTime  @default(now())

  @@unique([promoCodeId, userId])
  @@index([userId])
}

model Referral {
  id           String   @id @default(cuid())
  referrerId   String
  referrer     User     @relation("ReferrerReferrals", fields: [referrerId], references: [id])
  refereeId    String?
  referee      User?    @relation("RefereeReferrals", fields: [refereeId], references: [id])
  referralCode String   @unique
  rewardAmount Float    @default(5.00)
  isRedeemed   Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([referrerId])
}

model Tip {
  id            String      @id @default(cuid())
  riderId       String
  rider         User        @relation("TipGiver", fields: [riderId], references: [id])
  driverId      String
  driver        User        @relation("TipReceiver", fields: [driverId], references: [id])
  rideRequestId String
  rideRequest   RideRequest @relation(fields: [rideRequestId], references: [id])
  amount        Float
  createdAt     DateTime    @default(now())

  @@unique([rideRequestId, riderId])
  @@index([driverId])
}

model Wallet {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  balance      Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String   @id @default(cuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amount      Float
  type        String   // "credit", "debit", "tip_received", "referral_bonus", "loyalty_redeem", "refund"
  description String
  createdAt   DateTime @default(now())

  @@index([walletId, createdAt])
}

model SupportTicket {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation("UserTickets", fields: [userId], references: [id])
  rideRequestId String?
  subject       String
  description   String
  status        String   @default("open") // "open", "in_review", "resolved", "closed"
  category      String   // "fare_dispute", "safety", "lost_item", "driver_issue", "app_issue", "other"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId, status])
}
